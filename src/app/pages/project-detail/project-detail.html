<section class="min-h-[100svh] flex flex-col gap-4">
  <!-- Toolbar (match dashboard: no search, no Created text) -->
  <div class="sticky top-0 z-30 bg-white/70 backdrop-blur border-b border-white/40">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a routerLink="/dashboard" class="p-2 rounded-lg hover:bg-slate-100" aria-label="Back">
        <svg class="w-5 h-5 text-slate-700" viewBox="0 0 24 24" fill="none">
          <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </a>
      <img src="/assets/h_noname_logo.png" class="w-7 h-7 rounded-lg shadow mr-1" alt="" />
      <div class="font-semibold text-slate-900 truncate">
        {{ project()?.name || 'Project' }}
      </div>
      <!-- right side empty like dashboard -->
      <div class="ml-auto"></div>
    </div>
  </div>

  <!-- Body -->
  <div class="max-w-6xl mx-auto px-4 grid lg:grid-cols-[320px,1fr] gap-6 w-full">
    <!-- Left: Tables -->
    <aside class="glass w-full rounded-2xl p-4 h-fit">
      <div class="mb-3 flex items-center gap-2">
        <input
          class="input flex-1"
          [value]="keyword()"
          (input)="keyword.set($any($event.target).value)"
          placeholder="Filter tables..."
        />
        <button
          class="btn-primary-enhance !px-4 !py-2"
          (click)="createTable()"
          [disabled]="creating()"
        >
          New
        </button>
      </div>

      <ul class="space-y-1">
        @for (t of filteredTables(); track t.tableId) {
        <li>
          <button
            class="w-full table-item"
            [class.active]="selected()?.tableId === t.tableId"
            (click)="onSelect(t)"
          >
            <div class="font-medium">{{ t.name }}</div>
            <div class="text-[11px] text-slate-500">
              #{{ t.tableId }} • {{ t.createdAt | date : 'mediumDate' }}
            </div>
          </button>
          <div class="flex gap-2 mt-1 ml-1">
            <button class="mini-ghost" (click)="renameTable(t)" [disabled]="renaming()">
              Rename
            </button>
            <button
              class="mini-ghost text-rose-600 hover:bg-rose-50"
              (click)="deleteTable(t)"
              [disabled]="deleting()"
            >
              Delete
            </button>
          </div>
        </li>
        }
      </ul>
    </aside>

    <!-- Right: Preview -->
    <main class="glass rounded-2xl p-5">
      @if (!selected()) {
      <div class="text-slate-500">Select a table to preview.</div>
      } @else {
      <div class="flex items-center justify-between gap-3 mb-4">
        <div class="text-lg font-semibold text-slate-900">{{ selected()!.name }}</div>
        <div class="flex gap-2">
          <button class="btn-ghost-enhance !px-4 !py-2" (click)="openNewField()">Add field</button>
          <button class="btn-ghost-enhance !px-4 !py-2" (click)="gotoTableFull()">
            Open table
          </button>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-5">
        <!-- Fields (columns) -->
        <div class="rounded-xl border border-white/40 bg-white/70 backdrop-blur p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium mb-1">Fields</div>
              <div class="text-[12px] text-slate-500">
                Add Text, Number, Yes/No, Date, or Link to another table.
              </div>
            </div>
            <!-- <button class="btn-primary-enhance !px-3 !py-1.5" (click)="openNewField()">
              Add field
            </button> -->
          </div>

          <div class="space-y-2 max-h-64 overflow-auto pr-1 mt-3">
            @for (c of columns(); track c.columnId) {
            <div class="flex items-center justify-between text-sm">
              <div class="truncate">
                <span class="font-medium">{{ c.name }}</span>
                <span class="text-slate-500">: {{ humanType(c.dataType) }}</span>
              </div>
              <div class="text-[11px]">
                @if (c.isPrimary) {
                <span class="tag tag-primary" title="Unique identifier">Primary</span> } @if
                (!c.isNullable) {
                <span class="tag tag-warn" title="Required field">Required</span> }
              </div>
            </div>
            } @empty {
            <div class="text-sm text-slate-500">No fields yet.</div>
            }
          </div>
        </div>

        <!-- Rows preview -->
        <div class="rounded-xl border border-white/40 bg-white/70 backdrop-blur p-4">
          <div class="font-medium mb-2">Rows (top 5)</div>
          <div class="space-y-2 max-h-64 overflow-auto pr-1">
            @for (r of rows(); track r.rowId) {
            <pre class="code-pill">{{ r.data }}</pre>
            } @empty {
            <div class="text-sm text-slate-500">No rows.</div>
            }
          </div>

          <!-- Friendly compact view (non-technical) -->
          <div class="mt-2 space-y-2">
            @for (r of rows(); track r.rowId) {
            <div class="rounded-lg border border-slate-200 bg-white/70 p-3 text-sm">
              {{ renderEntry(r) }}
            </div>
            }
          </div>
        </div>
      </div>

      <div class="pt-3">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div class="flex-1 min-w-0">
            @if (status() !== 'idle') {
            <div
              class="status-pill"
              [ngClass]="{ ok: status() === 'success', bad: status() === 'error' }"
              role="status"
              aria-live="polite"
            >
              <span class="truncate">{{ statusMsg() }}</span>
            </div>
            }
          </div>
          <div class="flex gap-3 justify-end">
            <a class="btn-ghost-enhance !px-4 !py-2" routerLink="/dashboard">Back to dashboard</a>
          </div>
        </div>
      </div>
      }
    </main>
  </div>

  <!-- Add field modal -->
  @if (ui.newFieldOpen()) {
  <div
    class="fixed inset-0 z-[80] bg-black/40 flex items-center justify-center p-4"
    (click)="closeNewField()"
  >
    <div
      class="w-full max-w-md rounded-2xl bg-white shadow-2xl p-5 space-y-4"
      (click)="$event.stopPropagation()"
    >
      <div class="text-lg font-semibold">Add a field</div>

      <label class="block text-sm">
        <div class="mb-1 text-slate-600">Field name</div>
        <input
          class="input w-full"
          [value]="ui.newFieldName()"
          (input)="ui.newFieldName.set($any($event.target).value)"
          placeholder="e.g. Department"
        />
      </label>

      <label class="block text-sm">
        <div class="mb-1 text-slate-600">Field type</div>
        <select
          class="input w-full"
          [value]="ui.newFieldType()"
          (change)="ui.newFieldType.set($any($event.target).value)"
        >
          <option value="text">Text</option>
          <option value="number">Number</option>
          <option value="boolean">Yes/No</option>
          <option value="date">Date</option>
          <option value="link">Link to another table</option>
        </select>
      </label>

      @if (ui.newFieldType() === 'link') {
      <label class="block text-sm">
        <div class="mb-1 text-slate-600">Link target</div>
        <select (change)="ui.linkTargetTableId.set(+$any($event.target).value)">
          <option [value]="''">Select a table…</option>
          @for (t of tables(); track t.tableId) {
          <option [value]="t.tableId">{{ t.name }}</option>
          }
        </select>
        <div class="mt-1 text-[12px] text-slate-500">
          Users will pick a record from this table. IDs are hidden.
        </div>
      </label>
      }

      <div class="flex justify-end gap-2 pt-2">
        <button class="btn-ghost-enhance" (click)="closeNewField()">Cancel</button>
        <button class="btn-primary-enhance" [disabled]="!canCreateField()" (click)="createField()">
          Create field
        </button>
      </div>
    </div>
  </div>
  }
</section>
